# 全半形不敏感搜尋實作說明

## 功能概述

當「全半形須相符」選項設為 `false` 時，搜尋功能將使用自訂的 `_normalizeWidth()` 函數來處理全半形字元轉換，使全形和半形字元能夠互相匹配。

## 支援的字元類型

### 1. 全形ASCII字元 → 半形ASCII
- **全形字母**: Ａ-Ｚ、ａ-ｚ → A-Z、a-z
- **全形數字**: ０-９ → 0-9
- **全形標點**: ！"＃＄％＆'（）＊＋，－．／：；＜＝＞？＠［＼］＾＿｀｛｜｝～
- **範圍**: U+FF01-U+FF5E → U+0021-U+007E
- **轉換方法**: Unicode碼點 - 0xFEE0

**範例**:
```
ＡＢＣＤＥ → ABCDE
１２３４５ → 12345
（ＡＢＣ） → (ABC)
```

### 2. 全形空格 → 半形空格
- **全形空格**: 　(U+3000) → 空格 (U+0020)

**範例**:
```
Hello　World → Hello World
```

### 3. 全形片假名 → 半形片假名

#### 基本片假名（清音）
| 全形 | 半形 | 全形 | 半形 | 全形 | 半形 |
|-----|------|-----|------|-----|------|
| ア | ｱ | カ | ｶ | サ | ｻ |
| イ | ｲ | キ | ｷ | シ | ｼ |
| ウ | ｳ | ク | ｸ | ス | ｽ |
| エ | ｴ | ケ | ｹ | セ | ｾ |
| オ | ｵ | コ | ｺ | ソ | ｿ |

| 全形 | 半形 | 全形 | 半形 | 全形 | 半形 |
|-----|------|-----|------|-----|------|
| タ | ﾀ | ナ | ﾅ | ハ | ﾊ |
| チ | ﾁ | ニ | ﾆ | ヒ | ﾋ |
| ツ | ﾂ | ヌ | ﾇ | フ | ﾌ |
| テ | ﾃ | ネ | ﾈ | ヘ | ﾍ |
| ト | ﾄ | ノ | ﾉ | ホ | ﾎ |

| 全形 | 半形 | 全形 | 半形 | 全形 | 半形 |
|-----|------|-----|------|-----|------|
| マ | ﾏ | ヤ | ﾔ | ラ | ﾗ |
| ミ | ﾐ | ユ | ﾕ | リ | ﾘ |
| ム | ﾑ | ヨ | ﾖ | ル | ﾙ |
| メ | ﾒ | ワ | ﾜ | レ | ﾚ |
| モ | ﾓ | ヲ | ｦ | ロ | ﾛ |

| 全形 | 半形 |
|-----|------|
| ン | ﾝ |

#### 濁音片假名
| 全形 | 半形 | 全形 | 半形 | 全形 | 半形 |
|-----|------|-----|------|-----|------|
| ガ | ｶﾞ | ザ | ｻﾞ | ダ | ﾀﾞ |
| ギ | ｷﾞ | ジ | ｼﾞ | ヂ | ﾁﾞ |
| グ | ｸﾞ | ズ | ｽﾞ | ヅ | ﾂﾞ |
| ゲ | ｹﾞ | ゼ | ｾﾞ | デ | ﾃﾞ |
| ゴ | ｺﾞ | ゾ | ｿﾞ | ド | ﾄﾞ |

| 全形 | 半形 |
|-----|------|
| バ | ﾊﾞ |
| ビ | ﾋﾞ |
| ブ | ﾌﾞ |
| ベ | ﾍﾞ |
| ボ | ﾎﾞ |
| ヴ | ｳﾞ |

#### 半濁音片假名
| 全形 | 半形 |
|-----|------|
| パ | ﾊﾟ |
| ピ | ﾋﾟ |
| プ | ﾌﾟ |
| ペ | ﾍﾟ |
| ポ | ﾎﾟ |

#### 小寫片假名
| 全形 | 半形 | 全形 | 半形 |
|-----|------|-----|------|
| ァ | ｧ | ャ | ｬ |
| ィ | ｨ | ュ | ｭ |
| ゥ | ｩ | ョ | ｮ |
| ェ | ｪ | ヮ | ﾜ |
| ォ | ｫ | ッ | ｯ |

#### 特殊符號
| 全形 | 半形 | 說明 |
|-----|------|------|
| ・ | ･ | 中點 |
| ー | ｰ | 長音符號 |

### 4. 全形平假名 → 半形片假名

平假名會先轉換為片假名（Unicode碼點 + 0x0060），再轉為半形片假名。

**範例**:
```
あいうえお → ｱｲｳｴｵ
かきくけこ → ｶｷｸｹｺ
がぎぐげご → ｶﾞｷﾞｸﾞｹﾞｺﾞ
```

### 5. 半形片假名

半形片假名保持不變（範圍 U+FF61-U+FF9F）。

**範例**:
```
ｱｲｳｴｵ → ｱｲｳｴｵ
ｶﾞｷﾞｸﾞｹﾞｺﾞ → ｶﾞｷﾞｸﾞｹﾞｺﾞ
```

### 6. 全形中文標點符號 → 半形符號

| 全形 | 半形 | 說明 |
|-----|------|------|
| 、 | , | 頓號 → 逗號 |
| 。 | . | 句號 → 句點 |
| 「 | " | 左引號 |
| 」 | " | 右引號 |
| 『 | ' | 左雙引號 |
| 』 | ' | 右雙引號 |
| 〔 | [ | 左方括號 |
| 〕 | ] | 右方括號 |

## 實作細節

### 函數簽名
```dart
String _normalizeWidth(String text)
```

### 轉換邏輯

1. **逐字元處理**: 遍歷輸入文字的每個字元
2. **判斷字元類型**: 根據Unicode碼點範圍識別字元類型
3. **應用轉換規則**: 
   - 全形ASCII: 碼點 - 0xFEE0
   - 全形空格: 直接替換
   - 全形片假名: 使用映射表
   - 全形平假名: 先+0x0060轉片假名，再查映射表
   - 全形標點: 特殊映射
4. **組合結果**: 使用StringBuffer收集轉換後的字元

### 輔助函數

```dart
String _convertFullKatakanaToHalf(String char, String text, int index)
```

使用預定義的映射表將全形片假名轉為半形：
- 清音: 直接映射
- 濁音: 映射為「基本假名 + 濁音符號(ﾞ)」
- 半濁音: 映射為「基本假名 + 半濁音符號(ﾟ)」

## 使用範例

### 在 main.dart 中的使用

```dart
// 在 _performFind 函數中
if (!options.matchWidth) {
  processedText = _normalizeWidth(processedText);
  processedFindText = _normalizeWidth(processedFindText);
}

// 在 _textMatches 函數中
if (!options.matchWidth) {
  processedText = _normalizeWidth(processedText);
  processedPattern = _normalizeWidth(processedPattern);
}
```

### 搜尋範例

| 搜尋文字 | 可匹配的內容 | 說明 |
|---------|------------|------|
| `ABC` | ABC, ＡＢＣ | 全形英文匹配半形 |
| `123` | 123, １２３ | 全形數字匹配半形 |
| `ｱｲｳ` | ｱｲｳ, アイウ, あいう | 半形假名匹配全形片假名和平假名 |
| `カタカナ` | カタカナ, ｶﾀｶﾅ, かたかな | 全形片假名匹配半形和平假名 |
| `Hello World` | Hello World, Hello　World | 全形空格匹配半形空格 |
| `(ABC)` | (ABC), （ＡＢＣ） | 全形括號匹配半形 |

### 實際使用案例

#### 案例 1: 搜尋英文單字
```
搜尋: "Hello"
匹配: "Hello", "ＨＥＬＬＯ", "Ｈｅｌｌｏ"
```

#### 案例 2: 搜尋日文假名
```
搜尋: "カタカナ"
匹配: "カタカナ", "ｶﾀｶﾅ", "かたかな"
```

#### 案例 3: 搜尋混合內容
```
搜尋: "Code 123"
匹配: "Code 123", "Ｃｏｄｅ　１２３", "Code　123"
```

#### 案例 4: 搜尋濁音假名
```
搜尋: "ガギグゲゴ"
匹配: "ガギグゲゴ", "ｶﾞｷﾞｸﾞｹﾞｺﾞ"
```

## 性能考量

- **字元級迭代**: O(n) 時間複雜度，n為字串長度
- **StringBuffer**: 避免字串連接開銷
- **映射表查找**: O(1) 時間複雜度
- **條件執行**: 只在 `matchWidth = false` 時執行轉換
- **保留原字元**: 不需轉換的字元直接保留

## 特殊處理

### 濁音和半濁音
全形濁音假名（如「ガ」）轉換為半形時會變成兩個字元：
- 基本假名: ｶ
- 濁音符號: ﾞ
- 結果: ｶﾞ

這在搜尋時是透明的，因為兩端都會進行相同的轉換。

### 平假名轉換
平假名沒有對應的半形版本，因此會：
1. 先轉為片假名（+0x0060）
2. 再轉為半形片假名

這樣可以讓平假名、全形片假名、半形片假名三者互相匹配。

## 不受影響的字元

- **漢字（中文）**: 保持原樣
- **韓文字母**: 保持原樣
- **其他Unicode字元**: 保持原樣
- **已經是半形的字元**: 保持不變

## 測試

測試文件位於: `test/width_normalization_test.dart`

涵蓋測試：
- ✅ 全形ASCII轉半形
- ✅ 全形標點轉半形
- ✅ 全形空格轉半形
- ✅ 全形片假名轉半形（清音、濁音、半濁音、小寫）
- ✅ 平假名轉半形片假名
- ✅ 半形假名保持不變
- ✅ 全形中文標點轉換
- ✅ 混合文字轉換
- ✅ 中文字元不受影響
- ✅ 空字串處理

## 與大小寫正規化的配合

當同時啟用大小寫不敏感（`matchCase = false`）和全半形不敏感（`matchWidth = false`）時：

```dart
// 處理順序
processedText = text;

// 1. 先處理大小寫
if (!options.matchCase) {
  processedText = _normalizeCase(processedText);
}

// 2. 再處理全半形
if (!options.matchWidth) {
  processedText = _normalizeWidth(processedText);
}
```

**範例**:
```
原始文字: "ＡＢＣＤＥ"
大小寫正規化: "ａｂｃｄｅ"
全半形正規化: "abcde"
```

## Unicode 參考

### 全形ASCII範圍
- U+FF01-U+FF5E: 全形ASCII字元
- U+FF00: 全形空格的替代表示

### 假名範圍
- U+3041-U+309F: 平假名
- U+30A1-U+30FE: 片假名
- U+FF61-U+FF9F: 半形片假名

### 中文標點範圍
- U+3000-U+303F: CJK符號和標點

## 相關文件

- `lib/main.dart`: 主要實作位置（`_normalizeWidth` 和 `_convertFullKatakanaToHalf` 函數）
- `lib/bin/findreplace.dart`: 搜尋選項定義
- `test/width_normalization_test.dart`: 測試文件
- `CASE_INSENSITIVE_SEARCH.md`: 大小寫不敏感搜尋說明
