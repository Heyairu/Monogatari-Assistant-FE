# 搜尋與取代功能實作說明

## 已實作功能

### 1. 一般搜尋功能 (Find)
- ✅ **尋找下一個** (`_performFind` with `forward: true`)
  - 在編輯器文字中向前搜尋匹配項
  - 自動循環（到達末尾後從頭開始）
  - 顯示當前匹配項位置和總數
  
- ✅ **尋找上一個** (`_performFind` with `forward: false`)
  - 在編輯器文字中向後搜尋匹配項
  - 自動循環（到達開頭後從末尾開始）
  - 顯示當前匹配項位置和總數

### 2. 取代功能 (Replace)
- ✅ **單次取代** (`_performReplace`)
  - 取代當前選中的匹配項
  - 如果沒有選取，自動尋找下一個
  - 取代後自動尋找下一個匹配項
  - 顯示取代成功訊息

- ✅ **全部取代** (`_performReplaceAll`)
  - 一次取代所有匹配項
  - 從後往前取代，避免位置偏移問題
  - 顯示取代數量

### 3. 搜尋選項 (FindReplaceOptions)
所有選項在 `lib/bin/findreplace.dart` 中定義：

#### ✅ 已實作的選項：
1. **大小寫相同** (`matchCase`)
   - 區分大小寫搜尋
   
2. **全字拼寫需相符** (`wholeWord`)
   - 使用 `\b` 邊界匹配完整單詞（適用於英文）
   
3. **使用萬用字元** (`useWildcard`)
   - `?` 代表單一字元
   - `*` 代表任意字元
   
4. **全半形須相符** (`matchWidth`)
   - 檢查字元是否為全形或半形
   - 使用 Unicode 範圍判斷
   
5. **略過標點符號** (`ignorePunctuation`)
   - 自動移除英文和中文標點符號
   
6. **略過空白字元** (`ignoreWhitespace`)
   - 自動移除所有空白字元

## 核心功能實作

### 搜尋演算法 (`_findAllMatches`)
```dart
List<TextSelection> _findAllMatches(String text, String findText, FindReplaceOptions options)
```
- 根據選項預處理文字
- 支援正則表達式搜尋
- 支援萬用字元
- 支援全字匹配
- 返回所有匹配項的位置列表

### 文字匹配檢查 (`_textMatches`)
```dart
bool _textMatches(String text, String pattern, FindReplaceOptions options)
```
- 檢查兩個文字是否匹配
- 考慮所有搜尋選項
- 用於驗證當前選取是否匹配搜尋內容

### 全半形檢查 (`_checkWidthMatch`, `_isFullWidth`)
```dart
bool _checkWidthMatch(String text, String pattern)
bool _isFullWidth(String char)
```
- 判斷字元是否為全形
- 檢查兩個字串的全半形是否匹配
- 支援 CJK 字元和全形 ASCII

## 使用方式

### 1. 開啟搜尋取代視窗
- 點擊工具列的搜尋圖示 (🔍)
- 或使用快捷鍵（如果已設定）

### 2. 執行搜尋
1. 在「尋找內容」輸入框輸入要搜尋的文字
2. （可選）點擊齒輪圖示設定搜尋選項
3. 點擊向上/向下箭頭按鈕尋找上一個/下一個

### 3. 執行取代
1. 點擊展開按鈕顯示取代選項
2. 在「取代為」輸入框輸入取代文字
3. 點擊取代按鈕 (單次取代) 或全部取代按鈕

### 4. 搜尋選項
- 大小寫相同：區分大小寫
- 全字拼寫相符：匹配完整單詞
- 使用萬用字元：支援 `?` 和 `*`
- 全半形須相符：檢查全半形
- 略過標點符號：忽略標點
- 略過空白字元：忽略空白

## 技術細節

### 狀態管理
```dart
int _currentMatchIndex = -1;          // 當前匹配項索引
List<TextSelection> _searchMatches = [];  // 所有匹配項列表
```

### 正則表達式處理
- 使用 `RegExp.escape()` 轉義特殊字元
- 支援 Unicode 字元
- 動態構建正則表達式模式

### UI 互動
- 自動選中匹配項
- 顯示匹配數量和位置
- Toast 訊息反饋操作結果

## 已知限制
1. 全字匹配主要適用於英文單詞（使用 `\b` 邊界）
2. 萬用字元搜尋可能較慢（大文本）
3. 複雜正則表達式可能影響效能

## 未來改進建議
1. 加入搜尋歷史記錄
2. 支援正則表達式模式（完整支援）
3. 加入搜尋範圍選擇（選取區域內搜尋）
4. 優化大文件搜尋效能
5. 加入鍵盤快捷鍵支援
6. 高亮顯示所有匹配項

## 測試建議

### 基本測試
1. 簡單文字搜尋
2. 大小寫敏感搜尋
3. 全字匹配
4. 萬用字元搜尋

### 進階測試
1. 混合中英文搜尋
2. 全半形字元搜尋
3. 包含標點符號的搜尋
4. 大量取代操作

### 邊界測試
1. 空文字搜尋
2. 特殊字元搜尋
3. 超長文字搜尋
4. 無匹配項的情況
